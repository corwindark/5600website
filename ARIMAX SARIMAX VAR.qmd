---
title: "Data Sources"
author: "Corwin Dark"        
---


<h2> Planning Models </h2>

We have the following independent variables:
1. Interest Rate Expectation Changes - 3 Months 
2. Interest Rate Expectation Changes - 6 Months 
3. Interest Rate Expectation Changes - 1 Year
4. Extreme Weather Events - Daily Event Number
5. Extreme Weather Events - Daily Property Damage
6. Extreme Weather Events - Daily Casualties
7. Extreme Weather Events - Hurricanes
8. Expected Volatility (VIX) - Value
9. Expected Volatility (VIX) - Daily Change
10. Work Stoppages - Daily Striking Worker Total
11. Work Stoppages - Daily New Strike Beggining
12. Work Stoppages - Daily New Workers Striking




<h3> Preparing Exogenous Data </h3>

First we need to create all 12 predictors, then we can combine them to estimate the models as needed.
```{r}
library(tidyverse)
library(quantmod)
library(forecast)
library(tseries)
library(lubridate)
```

Let's  quickly retrieve the daily stock price ranges for the indices:
```{r}
spyIn <- quantmod::getSymbols("SPY", from = as.Date("2021/01/01"), to = as.Date("2023/09/30"), periodicity = "daily", src = "yahoo", auto.assign = FALSE)
qqqIn <- quantmod::getSymbols("QQQ", from = as.Date("2021/01/01"), to = as.Date("2023/09/30"), periodicity = "daily", src = "yahoo", auto.assign = FALSE)
iwmIn <- quantmod::getSymbols("IWM", from = as.Date("2021/01/01"), to = as.Date("2023/09/30"), periodicity = "daily", src = "yahoo", auto.assign = FALSE)


spyIn$spyRange <- (spyIn$SPY.High - spyIn$SPY.Low)/ spyIn$SPY.Open
qqqIn$qqqRange <- (qqqIn$QQQ.High - qqqIn$QQQ.Low)/ qqqIn$QQQ.Open
iwmIn$iwmRange <- (iwmIn$IWM.High - iwmIn$IWM.Low)/ iwmIn$IWM.Open
```

Now, let's gather the VIX data, since it is also treated like a stock price, and should be available from the same package
```{r}
vixIn <- quantmod::getSymbols("^VIX", from = as.Date("2021/01/01"), to = as.Date("2023/09/30"), periodicity = "daily", src = "yahoo", auto.assign = FALSE)

vixIn$dailyChange <- vixIn$VIX.Close - lag(vixIn$VIX.Close)
# 8 is vixIn$VIX.Close
# 9 is vixIn$dailyChange

#vixIn <- vixIn %>% 
#    mutate(date = ymd(index(vixIn)))
head(vixIn)
```

We have bond yields stored in a CSV, but let's calculate daily changes:
```{r}
yieldCurve <- read.csv('data/treasuries.csv')

yieldCurve$mo3delta <- yieldCurve$X3.Mo - lag(yieldCurve$X3.Mo)
yieldCurve$mo6delta <- yieldCurve$X6.Mo - lag(yieldCurve$X6.Mo)
yieldCurve$mo12delta <- yieldCurve$X1.YR - lag(yieldCurve$X1.YR) 

yieldCurve$Date <- mdy(yieldCurve$Date)
```

Worth noting: Both the treasury data and the VIX data only start on January 4th.


Next up, let's prepare the weather event data:
```{r}
weather_data <- read.csv('data/storms_clean.csv')


weather_data$month <- weather_data$BEGIN_YEARMONTH %% 100

weather_data <- weather_data %>%
    mutate(realdate = make_date(YEAR, month, BEGIN_DAY)) %>%
    mutate(DAMAGE_PROPERTY =  str_replace(DAMAGE_PROPERTY, "K", "") )  %>%
    mutate(DAMAGE_PROPERTY = as.numeric(DAMAGE_PROPERTY)) %>%
    mutate(DAMAGE_PROPERTY = replace_na(DAMAGE_PROPERTY, 0))


# Daily Event Number
daily_events <- weather_data %>%
    group_by(realdate) %>%
    summarize(events = length(EPISODE_ID))

# Daily Property Damage
daily_property <-  weather_data %>%
    group_by(realdate) %>%
    summarize(pdam = sum(DAMAGE_PROPERTY))

# Daily Daily Casualties
daily_casualties <-  weather_data %>%
    group_by(realdate) %>%
    summarize(pdam = sum(INJURIES_DIRECT) + sum(INJURIES_INDIRECT) + sum(DEATHS_DIRECT) + sum(DEATHS_INDIRECT))

# Daily Hurricanes
daily_hurricanes <- weather_data %>%
    filter(EVENT_TYPE == "Hurricane") %>%
    group_by(realdate) %>%
    summarize(events = length(EPISODE_ID))


# Daily Casualties
daily_hurricanes# Daily Hurricanes

```

Finally, lets get the striking worker data ready:
```{r}
strike_data <- read.csv('data/strikes.csv')

# clean date format
strike_data$start = mdy(strike_data$Work.stoppage.beginning.date)
strike_data$end = mdy(strike_data$Work.stoppage.ending.date)
strike_data$workers = as.numeric(str_replace(strike_data$Number.of.workers.2., ",", "" ))


head(strike_data)

target_dates <- ymd(index(spyIn))

daily_workers <- vector(mode = "numeric", length = length(target_dates))

for(i in seq_along(target_dates)) {
    tempDat <- strike_data %>%
        filter(start <= target_dates[i]) %>%
        filter(end >= target_dates[i])

    daily_workers[i] = sum(tempDat$workers)
}

plot(daily_workers, type = 'l')
     
```

Now, we can combined all of these datasets into one dataframe, joining on the date columns
```{r}
# Convert TS objects to df, and fix the date column
vixDF <- data.frame(vixIn)
vixDF$date <- ymd(index(vixIn))
spyDF <- data.frame(spyIn)
spyDF$date <- ymd(index(spyIn))
qqqDF <- data.frame(qqqIn)
qqqDF$date <- ymd(index(qqqIn))
iwmDF <- data.frame(iwmIn)
iwmDF$date <- ymd(index(iwmIn))

# Join symbols together
tickers <- left_join(spyDF, vixDF, by = 'date')
tickers <- left_join(tickers, qqqDF, by = 'date')
tickers <- left_join(tickers, iwmDF, by = 'date')


# Join Bond Yields

head(tickers)


```


<h3> Select Models Based on These Exogenous Variables </h3>

We will combine these 12 predictors into 5 models, for SPY, QQQ, and IWM intraday volatility:

<h4> Model 1: (ARIMAX) SPY ~ Interest Rate 1-Year + Daily Weather Property Damage + Daily VIX Change + Daily Striking Worker Total </h2>

This model is selected based on the literature review, which suggested that weather events and investor expecations could affect stock prices. This is the "kitchen sink" model, where I am throwing in variables from all data sources. 



<h4> Model 2: (VAR) SPY ~ Interest Rate 6-Months + Daily Weather Event Number + Daily VIX Value + Daily Striking Workers </h4>


```{r}

combined
#ggplot(yieldCurve, aes(x = Date, y = X6.Mo ) ) + geom_line() + geom_line(aes(x = ymd(index(vixIn)), y = vixIn$VIX.Close ) )




```



<h4> Model 3: (ARIMAX) IWM ~ Daily New Strikes Beggining + Casualties + Hurricanes + Interest Rate 3-Months </h4>


<h4> Model 4: (VAR/ARIMAX) QQQ ~ All Interest Rates + All Extreme Weather Events + Daily VIX Change + Daily Striking Workers </h4>


<h4> Model 5: (ARIMAX) QQQ ~ Interest Rate 3 months + Daily Property Damage + Daily VIX Change + Daily New Striking Workers </h4>


<h2> 