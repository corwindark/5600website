---
title: "Data Sources"
author: "Corwin Dark"        
---


<h2> Planning Models </h2>

We have the following independent variables:
1. Interest Rate Expectation Changes - 3 Months 
2. Interest Rate Expectation Changes - 6 Months 
3. Interest Rate Expectation Changes - 1 Year
4. Extreme Weather Events - Daily Event Number
5. Extreme Weather Events - Daily Property Damage
6. Extreme Weather Events - Daily Casualties
7. Extreme Weather Events - Hurricanes
8. Expected Volatility (VIX) - Value
9. Expected Volatility (VIX) - Daily Change
10. Work Stoppages - Daily Striking Worker Total
11. Work Stoppages - Daily New Strike Beggining
12. Work Stoppages - Daily New Workers Striking




<h3> Preparing Exogenous Data </h3>

First we need to create all 12 predictors, then we can combine them to estimate the models as needed.
```{r}
library(tidyverse)
library(quantmod)
library(forecast)
library(tseries)
library(lubridate)
```

Let's  quickly retrieve the daily stock price ranges for the indices:
```{r}
spyIn <- quantmod::getSymbols("SPY", from = as.Date("2021/01/01"), to = as.Date("2023/09/30"), periodicity = "daily", src = "yahoo", auto.assign = FALSE)
qqqIn <- quantmod::getSymbols("QQQ", from = as.Date("2021/01/01"), to = as.Date("2023/09/30"), periodicity = "daily", src = "yahoo", auto.assign = FALSE)
iwmIn <- quantmod::getSymbols("IWM", from = as.Date("2021/01/01"), to = as.Date("2023/09/30"), periodicity = "daily", src = "yahoo", auto.assign = FALSE)


spyIn$spyRange <- (spyIn$SPY.High - spyIn$SPY.Low)/ spyIn$SPY.Open
qqqIn$qqqRange <- (qqqIn$QQQ.High - qqqIn$QQQ.Low)/ qqqIn$QQQ.Open
iwmIn$iwmRange <- (iwmIn$IWM.High - iwmIn$IWM.Low)/ iwmIn$IWM.Open
```

Now, let's gather the VIX data, since it is also treated like a stock price, and should be available from the same package
```{r}
vixIn <- quantmod::getSymbols("^VIX", from = as.Date("2021/01/01"), to = as.Date("2023/09/30"), periodicity = "daily", src = "yahoo", auto.assign = FALSE)

vixIn$dailyChange <- vixIn$VIX.Close - lag(vixIn$VIX.Close)
# 8 is vixIn$VIX.Close
# 9 is vixIn$dailyChange

#vixIn <- vixIn %>% 
#    mutate(date = ymd(index(vixIn)))
head(vixIn)
```

We have bond yields stored in a CSV, but let's calculate daily changes:
```{r}
yieldCurve <- read.csv('data/treasuries.csv')

yieldCurve$mo3delta <- yieldCurve$X3.Mo - lag(yieldCurve$X3.Mo)
yieldCurve$mo6delta <- yieldCurve$X6.Mo - lag(yieldCurve$X6.Mo)
yieldCurve$mo12delta <- yieldCurve$X1.Yr - lag(yieldCurve$X1.Yr) 

yieldCurve$Date <- mdy(yieldCurve$Date)
```

Worth noting: Both the treasury data and the VIX data only start on January 4th.


Next up, let's prepare the weather event data:
```{r}
weather_data <- read.csv('data/storms_clean.csv')


weather_data$month <- weather_data$BEGIN_YEARMONTH %% 100

weather_data <- weather_data %>%
    mutate(realdate = make_date(YEAR, month, BEGIN_DAY)) %>%
    mutate(DAMAGE_PROPERTY =  str_replace(DAMAGE_PROPERTY, "K", "") )  %>%
    mutate(DAMAGE_PROPERTY = as.numeric(DAMAGE_PROPERTY)) %>%
    mutate(DAMAGE_PROPERTY = replace_na(DAMAGE_PROPERTY, 0))


# Daily Event Number
daily_events <- weather_data %>%
    group_by(realdate) %>%
    summarize(events = length(EPISODE_ID))

# Daily Property Damage
daily_property <-  weather_data %>%
    group_by(realdate) %>%
    summarize(pdam = sum(DAMAGE_PROPERTY))

# Daily Daily Casualties
daily_casualties <-  weather_data %>%
    group_by(realdate) %>%
    summarize(casualties = sum(INJURIES_DIRECT) + sum(INJURIES_INDIRECT) + sum(DEATHS_DIRECT) + sum(DEATHS_INDIRECT))

# Daily Hurricanes
daily_hurricanes <- weather_data %>%
    filter(EVENT_TYPE == "Hurricane") %>%
    group_by(realdate) %>%
    summarize(hurricaneWarnings = length(EPISODE_ID))


# Daily joined data

weather_merged <- full_join(daily_events, daily_property, by = "realdate")
weather_merged <- full_join(weather_merged, daily_casualties, by = 'realdate')
weather_merged <- full_join(weather_merged, daily_hurricanes, by = 'realdate')

head(weather_merged)
```

Finally, lets get the striking worker data ready:
```{r}
strike_data <- read.csv('data/strikes.csv')

# clean date format
strike_data$start = mdy(strike_data$Work.stoppage.beginning.date)
strike_data$end = mdy(strike_data$Work.stoppage.ending.date)
strike_data$workers = as.numeric(str_replace(strike_data$Number.of.workers.2., ",", "" ))


head(strike_data)

target_dates <- ymd(index(spyIn))

daily_workers <- vector(mode = "numeric", length = length(target_dates))

for(i in seq_along(target_dates)) {
    tempDat <- strike_data %>%
        filter(start <= target_dates[i]) %>%
        filter(end >= target_dates[i])

    daily_workers[i] = sum(tempDat$workers)
}

workerDF <- data.frame('workers' = daily_workers, 'date' = target_dates)
plot(daily_workers, type = 'l')
     
```

Now, we can combined all of these datasets into one dataframe, joining on the date columns
```{r}
# Convert TS objects to df, and fix the date column
vixDF <- data.frame(vixIn)
vixDF$date <- ymd(index(vixIn))
spyDF <- data.frame(spyIn)
spyDF$date <- ymd(index(spyIn))
qqqDF <- data.frame(qqqIn)
qqqDF$date <- ymd(index(qqqIn))
iwmDF <- data.frame(iwmIn)
iwmDF$date <- ymd(index(iwmIn))

# Join symbols together
tickers <- left_join(spyDF, vixDF, by = 'date')
tickers <- left_join(tickers, qqqDF, by = 'date')
tickers <- left_join(tickers, iwmDF, by = 'date')

# Join weather data
combinedData <- left_join(tickers, weather_merged, by = c("date" = "realdate"))

# Join Bond Yields
combinedData <- left_join(combinedData, yieldCurve, by = c("date" = "Date"))

# Join Labor Data
combinedData <- left_join(combinedData, workerDF, by = 'date')

head(combinedData)


```


<h3> Select Models Based on These Exogenous Variables </h3>

We will combine these 12 predictors into 5 models, for SPY, QQQ, and IWM intraday volatility:

<h4> Model 1: (ARIMAX) SPY ~ Interest Rate 1-Year + Daily Weather Property Damage + Daily VIX Change + Daily Striking Worker Total </h2>

This model is selected based on the literature review, which suggested that weather events and investor expecations could affect stock prices. This is the "kitchen sink" model, where I am throwing in variables from all data sources. However, looking at the variables individually, such as daily property damage vs. SPY daily price range, we don't nessecarily see clear correlation (see plot below which resembles white noise). But I am interested to see how these variables are related when taking many different contextual factors into account in the same model.

```{r}
ggplot(combinedData, aes(x = log(spyRange), y = log(pdam)) ) + geom_point() + labs(title = "3 Month Interest Rate Changes vs. VIX Change ", x = "Log SPY Daily Spread", y = "Log Property Damage From Storms")
```


<h4> Model 2: (VAR) SPY ~ Interest Rate 3-Months + Daily VIX Value </h4>

This model is based on a belief that there is an interrelationship between VIX prices and bond yields. This is because both would increase and decrease based on investor expectations for macroeconomic performance in upcoming months. If investors feel the economy will perform poorly, then this might predict bond yields lowering, as well as increased volatility which would be reflected by increases in the VIX. We also see a weak linear correlation in these daily values, as pictured in the plot below. 

```{r}
ggplot(combinedData, aes(x = mo3delta, y = dailyChange ) ) + geom_point() + labs(title = "3 Month Interest Rate Changes vs. VIX Change ", x = "Change in 3-Month Interest Rates", y = "Change in VIX Price")
```

<h4> Model 3: (ARIMAX) IWM ~ Daily New Strikes Beggining + Casualties + Hurricanes + Interest Rate 3-Months </h4>

This model is all about exogenous shocks. New strikes beggining and hurricane warnings are infrequent but extreme events, which have been grouped together with short-term interest rates (3 month window) to try and capture extreme-but-short-termm influences on volatility.

<h4> Model 4: (VAR/ARIMAX) QQQ ~ All Interest Rates + All Extreme Weather Events + Daily VIX Change + Daily Striking Workers </h4>
<h4> Model 5: (ARIMAX) QQQ ~ Interest Rate 3 months + Daily Property Damage + Daily VIX Change + Daily New Striking Workers </h4>

Models 4 and 5 follow the same logic as model 1, being selected based off of the literature review, but looking at QQQ as oppposed to SPY to see whether large-cap tech companies are more likely to be affected by this kind of volatility.

<h2> Model Selection </h2>

In this section, I will begin by identifying the candidate model structures for each of the 5 overarching models outlined above. I will identify candidate models through auto.arima for ARIMAX models, plus hand-selected values. For VAR models, I will identify 2 candidates for each overall model with the autoVAR function.

<h3> Model Selection for ARIMAX Models </h3>

<h3> Model Selection for VAR Models </h3>




